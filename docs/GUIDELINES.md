# 開発ガイドライン

## 入出力検証

clonoでは関数の入出力の型安全性を確保するために、`:pre`と`:post`条件を活用しています。

### 検証ルール

1. **公開関数の入出力を検証する**
    - すべての公開関数では、`:pre`条件で入力パラメータを検証する。
    - すべての公開関数では、`:post`条件で戻り値を検証する。
    - 例:
    ```clojure
    (defn build-href [key]
     {:pre [(spec/validate ::spec/id key "Invalid key is given.")]
      :post [(spec/validate ::spec/url % "Invalid URL is returned.")]}
     ...)
    ```
2. **マルチメソッドの各実装でも検証を行う**
    - `defmulti`の定義だけでなく、各`defmethod`でも`:pre`と`:post`条件を使って検証する。
    - 基底の仕様と同一、または強化された条件を使用する。
3. **エラーメッセージは具体的に**
    - 検証する際には`valid?`ではなく`blue.lions.clono.spec.validate`関数を使用し、明確なカスタムメッセージを州津力する。
    - 例: `(spec/validate ::spec/id key "Invalid key is given.")`

## 関数設計

### 責務の分離

- **単一責任の原則**: 各関数は、明確に定義された一つの役割のみを持つようにする。
- **build-xxx関数**: HTML、Markdown、URL生成などの変換機能は、`build-xxx`という名前の関数に分離する。
- **create-xxx関数**: データ構造の生成は、`create-xxx`という名前の関数に分離する。

### 再帰処理

- 再帰深度の制限を設けることを検討する。
- 最大深度に達した場合はログを出力して処理を終了する。

## プラグイン機構

1. **プラグインの構造**
    - CommonJSモジュールとして実装する。
    - `module.exports = function(node, baseName) { ... }`の形式で関数をエクスポートする。
2. **エラーハンドリング**
    - プラグイン内でエラーが発生した場合は、クラッシュせずに例外を投げる。
    - プラグインのエラーはclonoによってキャッチされ、デフォルト処理にフォールバックする。
3. **出力形式**
    - HTML文字列を返す。
    - 無効な出力（nullやオブジェクト）は許容されない。

## コードスタイル

1. **命名規則**
    - 変数と関数: kebab-caseで命名する（例: `build-href`）。
    - スペック名: kebab-caseで命名する（例: `::spec/non-blank-string`）。
    - 変数名や関数名にネームスペースのスラッシュを含める必要がある場合は、スラッシュをアンダースコアに置き換える（例: `common/alphabet-string-test`→`common_alphabet-string-test`）。
        - specの定義順の関係で一時的に利用する中間変数名や、specのテスト関数名を想定している。
2. **コメント**
    - コメントは英語で記述する。
    - 複雑なロジックには説明のコメントをつける。
    - 外部ライブラリの動作に依存する部分は、動作を説明するコメントをつける。
    - 説明的な関数名、変数名を使用してコメントの必要がないコードが理想ではあるが、あったほうが分かりやすい場面でコメントをつけることをためらわないこと。
3. **コレクション操作**
    - 関数型アプローチを優先する（`map`や`keep`などの高階関数を活用する）。
    - 副作用を避け、データ変換としてコードを設計する。

## エラーハンドリング

一貫したエラーハンドリングを行うため、以下のポリシーに従ってください。

### エラーの種類と対応方法

1. **構造的なエラー**（例: 辞書がない、必須パラメータがない）
   - `ex-info`を使用して例外を投げる。
   - 関連データを必ず含める（`:node`、`:base-name`など）。
   - 例: `(throw (ex-info "Heading dictionary is not found." {:dics dics :node node}))`
2. **コンテンツ関連のエラー**（例: IDが見つからない、参照先がない）
   - `blue.lions.clono.log/error`でログに記録する。
   - 処理を継続する（代替値を使用するか、部分的に処理をスキップする）。
   - 例: `(log/error "Reference node does not have ID." {:node node :base-name base-name})`
3. **警告レベルの問題**（例: 非推奨の機能、将来的に問題になる可能性がある）
   - `blue.lions.clono.log/warn`でログに記録する。
   - 例: `(log/warn "Plugin execution failed, using default logic." {...})`

### エラーメッセージ

- メッセージは英語で出力する。
- 明確で具体的なメッセージを提供する。

### データの含め方

例外やログの作成の際、以下のようなデータを追加で含めることが望ましいです。

- `:node` - 問題のあるノード
- `:base-name` - 処理中のファイル名
- `:cause` - 元の例外（存在する場合）
- `:missing` - 欠けている要素（IDなど）
